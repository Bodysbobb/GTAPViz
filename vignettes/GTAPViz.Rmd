---
title: "GTAPViz: Visualizing GTAP Model Results"
author: "Pattawee Puangchit"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GTAPViz: Visualizing GTAP Model Results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
rm(list=ls())
if (!require("HARplus")) {
    devtools::install_github('https://github.com/Bodysbobb/HARplus')
}

packages <- c("HARplus", "dplyr", "ggplot2", "devtools")

install.packages(setdiff(packages, rownames(installed.packages())))  
lapply(packages, library, character.only = TRUE)

```

# Introduction {#sec:introduction}

GTAPViz, built on the **HARplus** package, enhances the visualization of GTAP model results, making it easier for users to interpret and communicate economic simulation outputs. This vignette demonstrates how to create structured, publication-ready figures using GTAPVizâ€™s built-in visualization tools.

The visualization framework relies on the **`SL4Plot`** and **`HARPlot`** sheets, which specify the variables and figure titles used for plotting. Users can define these directly within an external mapping file or generate them dynamically in the R environment.

By leveraging HARplus for data extraction and GTAPViz for visualization, this package provides a streamlined workflow to generate insightful graphs without requiring extensive manual coding.

For an overview of data processing functionalities, refer to the separate vignette:  
[\href{../GTAPViz_data_processing.html}{GTAPViz: Automating GTAP Data Processing}](../GTAPViz_data_processing.html).



# Seting {#sec:setting}

```{r}
# Directory
project.folder <- "D:/One Drive/OneDrive - purdue.edu/GTAPViz Data/Plot"

# Define experiment name / output name 
case.name <- c("US_All", "US_All_RetalTar", "US_All_ReduceTar50", "US_All_RegReduceTar50",
                    "US_All10", "US_All10_RetalTar", "US_All10_ReduceTar50", "US_All10_RegReduceTar50")

# Adding Description / Unit (Yes/No/GTAPv7/Mix)
info.mode <- "GTAPv7"

# Output: (CSV, STATA, R) 
# "Yes" to opt for this output format, "No" to skip the output format
csv.output <- "No"    
stata.output <- "No"  
r.output <- "Yes"
txt.output <- "No"   

#-----DEV PERIOD ONLY (WILL BE DELETED--------#
#library(GTAPViz)
src.folder <- "D:/GitHub/GTAPViz/R"
setwd(src.folder)
#install()   # Install the package locally
devtools::load_all()  # Load functions without reinstalling
```

# Preparing Input Data

The rest of the code prepares the input, creates functions, and exports the output. You may skip to the [Execution](#sec:execution) section for details on executing functions separately.

```{r}
# ==============================================================================
# DO NOT EDIT BELOW THIS LINE
# ==============================================================================
# Load Input Data from Excel Mapping File
input.folder <- paste0(project.folder, "/in")
output.folder <- paste0(project.folder, "/out")
mapping.file <- paste0(project.folder, "/map/OutputMapping.xlsx")
sl4plot <- readxl::read_xlsx(mapping.file, sheet = "SL4Plot")
harplot <- readxl::read_xlsx(mapping.file, sheet = "HARPlot")
```


```{r Preparing Data for Plot}
# Define variables to extract
# Region to be plotted
selected_regions <- c("USA", "CHN", "CAN", "ASEAN", "ROW")

# Sector to be plotted (NULL to select all)
selected_sector <- NULL

# Extract data with region and experiment filters
plot.dta <- plot_gtap_data(
  sl4file  = sl4plot,
  harfile = harplot, 
  experiment  = case.name,
  mapping_info = info.mode, 
  region_select  = selected_regions,
  sector_select = selected_sector,
  project_dir = project.folder
)

# Convert Value if Needed
sl4.plot.data <- convert_units(
  sl4.plot.data,
  change_unit_from = c("million USD"),
  change_unit_to = c("billion USD"),
  adjustment = c("/1000")
)

har.plot.data <- convert_units(
  har.plot.data,
  change_unit_from = c("million USD"),
  change_unit_to = c("billion USD"),
  adjustment = c("/1000")
)

# Convert the column name if needed
rename_col <- data.frame(
  old = c("REG", "COMM", "ACTS"),
  new = c("Region", "Commodity", "Activity")
  )
sl4.plot.data <- rename_dims(sl4.plot.data, rename_col)
har.plot.data <- rename_dims(har.plot.data, rename_col)

# Define the sublists to keep in the first list
reg_dim <- c("qgdp", "ppriv", "EV", "tot", "u")
reg_sl4 <- sl4.plot.data[reg_dim]
reg_sl4_map <- sl4plot[sl4plot$Variable %in% reg_dim, ]
reg_oth_sl4 <- sl4.plot.data[setdiff(names(sl4.plot.data), reg_dim)]
reg_oth_map <- sl4plot[!sl4plot$Variable %in% reg_dim, ]

```


```{r Comparison Plot}
lapply(reg_sl4, function(df) {
  comparison_plot(df,
                  x_axis_from = "Region",
                  plot_var = reg_sl4_map,
                  title_prefix = "Impact on",
                  output_dir = output.folder,
                  compare_by_x_axis = FALSE,
                  separate_figure = FALSE,
                  color_tone = "grey",
                  width = 20,
                  height = 12,
                  legend_position = "bottom")})

report_table(reg_sl4, vars = reg_sl4_map$Variable, 
             col_names = reg_sl4_map$PlotTitle,  
             x_axis_from = "Region",
             output_dir = output.folder)
```


```{r GTAP Macro Plot}
Macros <- do.call(gtap_macros_data, c(as.list(paste0(input.folder, "/", case.name, ".sl4")),
                  list(experiment_names = case.name)))

# Selecting Variables
selected_marcro <- c("pgdpwld", "qgdpwld", "vgdpwld")
macros_new_name <- c("pgdpwld", "qgdpwld", "vgdpwld")
macro.map <- data.frame(
  Variable = selected_marcro,
  PlotTitle = macros_new_name,
  stringsAsFactors = FALSE
)

# Plotting
macro_plot(Macros,
           plot_var = macro.map,
           compare_by_x_axis = FALSE,
           color_tone = "grey",
           output_dir = output.folder,
           panel_rows = 2,
           width = 45,
           separate_figure = FALSE,
           legend_position = "bottom")

# Reporting Table
scalar_table(Macros, vars = selected_marcro, 
             output_dir = output.folder)
```

```{r Detail Plot}
lapply(reg_oth_sl4, function(df) {
  detail_plot(df,
              y_axis_from = c("Commodity", "Activity"),
              figure_separate_by = "Region",
              plot_var = reg_oth_map,
              output_dir = output.folder,
              top_impact = NULL,
              panel_rows = 1,
              panel_cols = 8,
              width = 45)})

lapply(reg_oth_sl4, function(df) {
  detail_plot(df,
              y_axis_from = c("Commodity", "Activity"),
              figure_separate_by = "Region",
              plot_var = reg_oth_map,
              output_dir = output.folder,
              top_impact = 10,
              panel_rows = 1,
              panel_cols = 8,
              width = 45)})
```

```{r Decomposition Plot}
# Rename Value if needed
welfare <- har.plot.data[["A"]]
welfare[["Variable"]] <- "Welfare"
welfare <- rename_value(har.plot.data[["A"]], 
                        column_name = "COLUMN",
                        original_values = c("alloc_A1", "ENDWB1", "tech_C1", "pop_D1", "pref_G1", "tot_E1", "IS_F1"),
                        new_values = c("Alloc Eff.", "Endwb", "Tech Chg.", "Pop", "Perf", "ToT", "I-S"))

# Define Decomposition
stack_plot(data = welfare,
          x_axis_from = "Region",
          stack_value_from = "COLUMN",
          title_prefix = "Decomposition",
          output_dir = output.folder,
          separate_figure = FALSE,
          color_tone = "green",
          width = 30,
          height = 15,
          legend_position = "bottom",
          unstack_plot = FALSE)

# Table of Decomposition
decomp_table(har.plot.data, 
             header = c("A", "E1"),
             wide_cols = list(A = "COLUMN", E1 = "PRICES"),
             total_column = TRUE,
             output_dir = output.folder,
             export_table = TRUE)
```

# References {.unnumbered}
